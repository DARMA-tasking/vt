
#
# Usage:
# ------
#
# This docker compose file parameterizes build configurations using environment
# variables from the host. The default values for the build configuration
# variables are set in `.env`.
#
# Variables:
#   ARCH={amd64, arm64v8, ...}
#   COMPILER_TYPE={gnu, clang, intel, nvidia}
#   COMPILER={gcc-8, gcc-9, gcc-10,
#             clang-8, clang-9, clang-10,
#             icpc, icpx,
#             nvcc-11, nvcc-11.2}
#   REPO=lifflander1/vt
#   UBUNTU={18.04, 20.04, 22.04}
#   ULIMIT_CORE=0
#
# DARMA/vt Configuration Variables:
#   VT_LB=1                   # Enable load balancing
#   VT_TRACE=0                # Enable tracing
#   VT_MIMALLOC=0             # Enable mimalloc memory allocator
#   VT_DOCS=0                 # Enable doxygen build
#   VT_TRACE_RT=0             # Enable tracing at runtime (for testing)
#   VT_ASAN=0                 # Enable address sanitizer
#   VT_UBSAN=0                # Enable undefined behavior sanitizer
#   VT_WERROR=1               # Treat all warnings as errors
#   VT_EXTENDED_TESTS=1       # Build all the extended testing
#   VT_ZOLTAN=0               # Build with Zoltan enabled
#   VT_UNITY_BUILD=0          # Build with Unity/Jumbo mode enabled
#   VT_PRODUCTION_BUILD=0     # Disable assertions and debug prints
#   VT_FCONTEXT=0             # Force use of fcontext for threading
#   VT_DIAGNOSTICS=1          # Build with diagnostics enabled
#   VT_DIAGNOSTICS_RUNTIME=0  # Enable diagnostics collection at runtime by default
#   BUILD_TYPE=release        # CMake build type
#   CODE_COVERAGE=0           # Enable generation of code coverage reports
#   VT_DEBUG_VERBOSE          # Enable verbose debug prints at compile-time
#   VT_NO_COLOR_ENABLED=0     # Set --vt_no_color flag to true by default
#   VT_BUILD_SHARED_LIBS=0    # Build VT as shared library
#
# In order to run in the container, there are two stages. First, one must build
# or pull the base container with the variables exported (or using the defaults
# in `vt/.env` that configure it:
#
# For instance, if you want an interactive intel build with icpx that enables
# VT tracing, run the following commands:
#
# $ export COMPILER_TYPE=intel
# $ export COMPILER=icpx
# $ export HOST_COMPILER=icpx
# $ export VT_TRACE=1
# $ docker-compose pull ubuntu-cpp-interactive
# $ docker-compose run ubuntu-cpp-interactive
# # /vt/ci/build_cpp.sh /vt /build
#
# For a non-interactive build with gcc-8, since gnu is the default compiler
# type, one may do the following:
#
#  $ COMPILER=gcc-8 docker-compose pull ubuntu-cpp
#  $ COMPILER=gcc-8 docker-compose run ubuntu-cpp
#

# Need verision >= 3.5 for the features in use
version: '3.8'

# Named volumes must be predefined according the docker compose rules. Many
# combinations have already been added, but if a needed configuration is missing
# add it to this list. For example, for ARM64v8 on Ubuntu 20.04 with clang-9,
# add `arm64v8-ubuntu-20.04-clang-9-clang-9-cache`.
volumes:
  amd64-ubuntu-18.04-clang-8-clang-8-cache:
  amd64-ubuntu-18.04-clang-9-clang-9-cache:
  amd64-ubuntu-20.04-clang-10-clang-10-cache:
  amd64-ubuntu-22.04-clang-11-clang-11-cache:
  amd64-ubuntu-18.04-gcc-8-gcc-8-cache:
  amd64-ubuntu-20.04-gcc-9-gcc-9-cache:
  amd64-ubuntu-20.04-gcc-10-gcc-10-cache:
  amd64-ubuntu-22.04-gcc-12-gcc-12-cache:
  amd64-ubuntu-18.04-icpx-icpx-cache:
  amd64-ubuntu-18.04-icpc-icpc-cache:
  amd64-ubuntu-20.04-gcc-9-11.0.3-cache:
  amd64-ubuntu-20.04-gcc-9-11.2.0-cache:
  amd64-alpine-clang-8-clang-8-cache:
  amd64-alpine-clang-9-clang-9-cache:
  amd64-alpine-clang-10-clang-10-cache:
  amd64-alpine-clang-11-clang-11-cache:
  amd64-alpine-clang-13-clang-13-cache:
  amd64-alpine-gcc-8-gcc-8-cache:
  amd64-alpine-gcc-9-gcc-9-cache:
  amd64-alpine-gcc-10-gcc-10-cache:
  amd64-alpine-gcc-12-gcc-12-cache:
  amd64-alpine-icpx-icpx-cache:
  amd64-alpine-icpc-icpc-cache:
  amd64-alpine-gcc-9-11.0.3-cache:
  amd64-alpine-gcc-9-11.2.0-cache:
  arm64v8-ubuntu-18.04-clang-8-clang-8-cache:
  arm64v8-ubuntu-18.04-clang-9-clang-9-cache:
  arm64v8-ubuntu-20.04-clang-10-clang-10-cache:
  arm64v8-ubuntu-22.04-clang-11-clang-11-cache:
  arm64v8-ubuntu-18.04-gcc-8-gcc-8-cache:
  arm64v8-ubuntu-20.04-gcc-9-gcc-9-cache:
  arm64v8-ubuntu-20.04-gcc-10-gcc-10-cache:
  arm64v8-ubuntu-22.04-gcc-12-gcc-12-cache:
  arm64v8-ubuntu-18.04-icpx-icpx-cache:
  arm64v8-ubuntu-18.04-icpc-icpc-cache:
  arm64v8-ubuntu-20.04-gcc-9-11.0.3-cache:
  arm64v8-ubuntu-20.04-gcc-9-11.2.0-cache:
  arm64v8-alpine-clang-8-clang-8-cache:
  arm64v8-alpine-clang-9-clang-9-cache:
  arm64v8-alpine-clang-10-clang-10-cache:
  arm64v8-alpine-clang-11-clang-11-cache:
  arm64v8-alpine-clang-13-clang-13-cache:
  arm64v8-alpine-gcc-8-gcc-8-cache:
  arm64v8-alpine-gcc-9-gcc-9-cache:
  arm64v8-alpine-gcc-10-gcc-10-cache:
  arm64v8-alpine-gcc-12-gcc-12-cache:
  arm64v8-alpine-icpx-icpx-cache:
  arm64v8-alpine-icpc-icpc-cache:
  arm64v8-alpine-gcc-9-11.0.3-cache:
  arm64v8-alpine-gcc-9-11.2.0-cache:

# Define basic rules for ccache used across multiple services. The beauty of
# docker compose with cached volumes is that similarly configured builds will
# reuse a ccache volume making build speeds much faster than a fresh build each
# time.
x-ccache: &ccache
  CCACHE_COMPILERCHECK: content
  CCACHE_COMPRESS: 1
  CCACHE_COMPRESSLEVEL: 5
  CCACHE_MAXSIZE: 700M
  CCACHE_DIR: /build/ccache

# Define rules for VT configuration options across various services
x-vtopts: &vtopts
  VT_LB_ENABLED: ${VT_LB:-1}
  VT_TRACE_ENABLED:  ${VT_TRACE:-0}
  VT_MIMALLOC_ENABLED: ${VT_MIMALLOC:-0}
  VT_DOXYGEN_ENABLED: ${VT_DOCS:-0}
  VT_TRACE_RUNTIME_ENABLED: ${VT_TRACE_RT:-0}
  VT_BUILD_TRACE_ONLY: ${VT_TRACE_ONLY:-0}
  VT_ASAN_ENABLED: ${VT_ASAN:-0}
  VT_UBSAN_ENABLED: ${VT_UBSAN:-0}
  VT_WERROR_ENABLED: ${VT_WERROR:-1}
  VT_POOL_ENABLED: ${VT_POOL:-1}
  VT_ZOLTAN_ENABLED: ${VT_ZOLTAN:-0}
  VT_UNITY_BUILD_ENABLED: ${VT_UNITY_BUILD:-0}
  VT_PRODUCTION_BUILD_ENABLED: ${VT_PRODUCTION_BUILD:-0}
  VT_FCONTEXT_ENABLED: ${VT_FCONTEXT:-0}
  VT_DIAGNOSTICS_ENABLED: ${VT_DIAGNOSTICS:-1}
  VT_DIAGNOSTICS_RUNTIME_ENABLED: ${VT_DIAGNOSTICS_RUNTIME:-0}
  CMAKE_BUILD_TYPE: ${BUILD_TYPE:-release}
  VT_MPI_GUARD_ENABLED: ${VT_MPI_GUARD:-1}
  VT_EXTENDED_TESTS_ENABLED: ${VT_EXTENDED_TESTS:-1}
  CODE_COVERAGE: ${CODE_COVERAGE:-0}
  https_proxy: ${PROXY-}
  http_proxy: ${PROXY-}
  LSAN_OPTIONS: ${LSAN_OPTIONS-}
  UBSAN_OPTIONS: ${UBSAN_OPTIONS-}
  VT_CI_BUILD: ${VT_CI_BUILD:-0}
  VT_DEBUG_VERBOSE: ${VT_DEBUG_VERBOSE-}
  VT_TESTS_NUM_NODES: ${VT_TESTS_NUM_NODES:-}
  VT_NO_COLOR_ENABLED: ${VT_NO_COLOR:-0}
  BUILD_SHARED_LIBS: ${VT_BUILD_SHARED_LIBS:-0}
  VT_INCLUSION_TYPE: ${VT_INCLUSION:-TPL}
  CODECOV_TOKEN: ${CODECOV_TOKEN:-}
  TEST_LB_SCHEMA: ${TEST_LB_SCHEMA:-0}
  CMAKE_CXX_STANDARD: ${CMAKE_CXX_STANDARD:-17}

services:
  ##############################################################################
  # C++ builds of VT on ubuntu/alpine platform from container baseline
  # Ubuntu gcc-12 debug build:
  #   docker-compose run -e CMAKE_BUILD_TYPE=debug ubuntu-cpp
  ubuntu-cpp:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${COMPILER_TYPE}-cpp.dockerfile
      args: &default-args
        arch: ${ARCH}
        proxy: ${PROXY}
        compiler: ${COMPILER}
        host_compiler: ${HOST_COMPILER}
        ubuntu: ${UBUNTU}
        ubsan_enabled: ${VT_UBSAN:-0}
        zoltan_enabled: ${VT_ZOLTAN:-0}
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: &ulimits
      core: ${ULIMIT_CORE}
    environment:
      <<: [*ccache, *vtopts]
    volumes: &ubuntu-volumes
      - .:/vt:delegated
      - ${CACHE}${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cache:/build:delegated
    command: &vt-cpp-command >
      /bin/bash -c "
        /vt/ci/build_cpp.sh /vt /build &&
        /vt/ci/test_cpp.sh  /vt /build &&
        /vt/ci/build_vt_sample.sh /vt /build"

  ##############################################################################
  # C++ build/test/clean target for VT on ubuntu platform from container
  # baseline.
  #
  # Example:
  #   docker-compose run ubuntu-cpp-clean
  ubuntu-cpp-clean:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${COMPILER_TYPE}-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
    volumes: *ubuntu-volumes
    command: &vt-build-test-clean-cpp-command >
      /bin/bash -c "
        /vt/ci/build_cpp.sh /vt /build &&
        /vt/ci/test_cpp.sh  /vt /build &&
        /vt/ci/build_vt_sample.sh /vt /build &&
        /vt/ci/clean_cpp.sh /vt /build"

  ##############################################################################
  # C++ build/test/clean target for VT on ubuntu platform from container
  # baseline without installing.
  #
  # Example:
  #   docker-compose run ubuntu-cpp-clean-noinstall
  ubuntu-cpp-clean-noinstall:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${COMPILER_TYPE}-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
    volumes: *ubuntu-volumes
    command: &vt-build-test-clean-noinstall-cpp-command >
      /bin/bash -c "
        /vt/ci/build_cpp.sh /vt /build all &&
        /vt/ci/test_cpp.sh  /vt /build &&
        /vt/ci/clean_cpp.sh /vt /build"

  ##############################################################################
  # Interactive C++ setup of VT on ubuntu platform from container baseline.
  #
  # After running:
  #   docker-compose run ubuntu-cpp-interactive
  #
  # You will get a command line where you can run the build command:
  #   $ /vt/ci/build_cpp.sh /vt /build
  #   $ /vt/ci/test_cpp.sh  /vt /build
  #   $ /vt/ci/build_vt_sample.sh /vt /build
  ubuntu-cpp-interactive:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${COMPILER_TYPE}-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
    volumes: *ubuntu-volumes

  ##############################################################################
  # C++ build/test/clean target for VT using OpenMPI instead of the default
  # mpich.
  #
  # Note: This is a separate target because it requires a different image and
  # modifying all the other container/image names to be parameterized over
  # MPI requires a lot of changes.
  ubuntu-cpp-clean-openmpi:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-openmpi-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${UBUNTU}-${COMPILER_TYPE}-openmpi-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-openmpi-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
      OMPI_MCA_btl: "^vader"
    volumes: *ubuntu-volumes
    command: *vt-build-test-clean-cpp-command

  ##############################################################################
  # Interactive C++ setup of VT on ubuntu platform from container baseline for
  # OpenMPI.
  ubuntu-cpp-interactive-openmpi:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-openmpi-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${UBUNTU}-${COMPILER_TYPE}-openmpi-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-openmpi-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
      OMPI_MCA_btl: "^vader"
    volumes: *ubuntu-volumes

  ##############################################################################
  # Build C++ container with VT installed in the container on ubuntu platform
  # from container baseline.
  ubuntu-vt:
    image: ${REPO}:vt-${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: build
      dockerfile: ci/docker/ubuntu-${COMPILER_TYPE}-cpp.dockerfile
      args:
        <<: [*default-args, *vtopts]
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
    volumes: *ubuntu-volumes
    command: &cpp-command >
      /bin/bash -c "
        /vt/ci/test_cpp.sh  /vt /build"

  ##############################################################################
  # Build documentation for VT in the container on ubuntu platform from
  # container baseline.
  ubuntu-docs:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-docs
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${COMPILER_TYPE}-docs.dockerfile
      args:
        <<: *default-args
        token: ${TOKEN}
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: *ccache
      VT_LB_ENABLED: ${VT_LB:-1}
      VT_TRACE_ENABLED:  ${VT_TRACE:-1}
      VT_DIAGNOSTICS_ENABLED: 1
      VT_DOXYGEN_ENABLED: 1
      CMAKE_BUILD_TYPE: ${BUILD_TYPE:-release}
    volumes: *ubuntu-volumes
    command: &docs-cpp-command >
      /bin/bash -c "
        /vt/ci/build_cpp.sh /vt /build ${TOKEN}"

  ##############################################################################
  # Build vt sample project using DARMA-vt installed from spack package.
  ubuntu-spack:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-openmpi-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${UBUNTU}-${COMPILER_TYPE}-openmpi-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-openmpi-cpp
    ulimits: *ulimits
    environment:
      <<: *vtopts
    volumes: *ubuntu-volumes
    command:
      /bin/bash -c "
        /vt/ci/test_spack_package.sh"

  ##############################################################################
  # Interactive build documentation for VT in the container on ubuntu platform
  # from container baseline.
  ubuntu-docs-interactive:
    image: ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-docs
    build:
      context: .
      target: base
      dockerfile: ci/docker/ubuntu-${UBUNTU}-${COMPILER_TYPE}-docs.dockerfile
      args:
        <<: *default-args
      cache_from:
        - ${REPO}:${ARCH}-ubuntu-${UBUNTU}-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: *ccache
      VT_LB_ENABLED: ${VT_LB:-1}
      VT_TRACE_ENABLED:  ${VT_TRACE:-1}
      VT_DIAGNOSTICS_ENABLED: 1
      VT_DOXYGEN_ENABLED: 1
      CMAKE_BUILD_TYPE: ${BUILD_TYPE:-release}
    volumes: *ubuntu-volumes

  ##############################################################################
  # C++ build of VT within an alpine linux container (limited to clang
  # compilers)
  alpine-cpp:
    image: ${REPO}:${ARCH}-alpine-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/alpine-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-alpine-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
    volumes: &alpine-volumes
      - .:/vt:delegated
      - ${CACHE}${ARCH}-alpine-${HOST_COMPILER}-${COMPILER}-cache:/build:delegated
    command: *vt-cpp-command

  ##############################################################################
  # C++ build/test/clean target for VT on alpine platform from container
  # baseline.
  alpine-cpp-clean:
    image: ${REPO}:${ARCH}-alpine-${HOST_COMPILER}-${COMPILER}-cpp
    build:
      context: .
      target: base
      dockerfile: ci/docker/alpine-cpp.dockerfile
      args: *default-args
      cache_from:
        - ${REPO}:${ARCH}-alpine-${HOST_COMPILER}-${COMPILER}-cpp
    ulimits: *ulimits
    environment:
      <<: [*ccache, *vtopts]
    volumes: *alpine-volumes
    command: *vt-build-test-clean-cpp-command
